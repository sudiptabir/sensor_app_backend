<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Device Access Control - Admin Portal</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
  <style>
    body { background: #f5f7fa; }
    .sidebar {
      min-height: 100vh;
      background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    .sidebar a {
      color: rgba(255,255,255,0.8);
      text-decoration: none;
      padding: 15px 20px;
      display: block;
    }
    .sidebar a:hover, .sidebar a.active {
      background: rgba(255,255,255,0.1);
      color: white;
    }
  </style>
</head>
<body>
  <div class="container-fluid">
    <div class="row">
      <%- include('partials/sidebar', { activePage: 'devices', adminName }) %>
      
      <main class="col-md-10 ms-sm-auto px-4 py-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <div>
            <h1>Device Access Control</h1>
            <p class="text-muted">Device: <strong><%= device.name || device.id %></strong></p>
          </div>
          <a href="/devices" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> Back to Devices
          </a>
        </div>
        
        <div class="row mb-4">
          <div class="col-md-6">
            <div class="card">
              <div class="card-header">
                <h5>Grant Access to User</h5>
              </div>
              <div class="card-body">
                <form id="grantAccessForm">
                  <div class="mb-3">
                    <label class="form-label">User ID</label>
                    <input type="text" class="form-control" id="userId" required>
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Access Level</label>
                    <select class="form-select" id="accessLevel">
                      <option value="viewer">Viewer (Read Only)</option>
                      <option value="controller">Controller (Full Access)</option>
                    </select>
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Expires At (Optional)</label>
                    <input type="datetime-local" class="form-control" id="expiresAt">
                  </div>
                  <button type="submit" class="btn btn-primary">Grant Access</button>
                </form>
              </div>
            </div>
          </div>
        </div>
        
        <div class="card">
          <div class="card-header">
            <h5>Current Access List</h5>
          </div>
          <div class="card-body">
            <table class="table">
              <thead>
                <tr>
                  <th>User ID</th>
                  <th>Access Level</th>
                  <th>Granted By</th>
                  <th>Granted At</th>
                  <th>Expires</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <% accessList.forEach(access => { %>
                  <tr class="<%= access.is_blocked ? 'table-danger' : '' %>">
                    <td><code><%= access.user_id %></code></td>
                    <td><span class="badge bg-info"><%= access.access_level %></span></td>
                    <td><%= access.granted_by %></td>
                    <td><%= new Date(access.granted_at).toLocaleString() %></td>
                    <td><%= access.expires_at ? new Date(access.expires_at).toLocaleString() : 'Never' %></td>
                    <td>
                      <% if (access.is_blocked) { %>
                        <span class="badge bg-danger">Blocked</span>
                        <small class="text-muted d-block"><%= access.reason %></small>
                      <% } else { %>
                        <span class="badge bg-success">Active</span>
                      <% } %>
                    </td>
                    <td>
                      <% if (!access.is_blocked) { %>
                        <button class="btn btn-sm btn-danger" onclick="revokeAccess('<%= access.user_id %>')">
                          <i class="bi bi-x-circle"></i> Revoke
                        </button>
                      <% } %>
                    </td>
                  </tr>
                <% }); %>
              </tbody>
            </table>
          </div>
        </div>
      </main>
    </div>
  </div>
  
  <script>
    const deviceId = '<%= device.id %>';
    
    document.getElementById('grantAccessForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const data = {
        userId: document.getElementById('userId').value,
        accessLevel: document.getElementById('accessLevel').value,
        expiresAt: document.getElementById('expiresAt').value || null
      };
      
      try {
        const response = await fetch(`/api/devices/${deviceId}/grant-access`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        
        if (response.ok) {
          alert('Access granted successfully');
          location.reload();
        } else {
          alert('Failed to grant access');
        }
      } catch (error) {
        alert('Error: ' + error.message);
      }
    });
    
    async function revokeAccess(userId) {
      const reason = prompt('Enter reason for revoking access:');
      if (!reason) return;
      
      try {
        const response = await fetch(`/api/devices/${deviceId}/revoke-access`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userId, reason })
        });
        
        if (response.ok) {
          alert('Access revoked successfully');
          location.reload();
        } else {
          alert('Failed to revoke access');
        }
      } catch (error) {
        alert('Error: ' + error.message);
      }
    }
  </script>
</body>
</html>
